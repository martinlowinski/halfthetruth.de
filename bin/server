#!/usr/bin/env ruby

# Run the server on the specified port, if required
require 'webrick'
include WEBrick

options = {}
options['baseurl'] = "/"
options['server_port'] = 4000

# Get source and destination from command line
case ARGV.size
  when 0
  when 1
    options['destination'] = ARGV[0]
  when 2
    options['source']      = ARGV[0]
    options['destination'] = ARGV[1]
  else
    puts "Invalid options. Run `jekyll --help` for assistance."
    exit(1)
end

destination = options['destination'] 
FileUtils.mkdir_p(destination)

mime_types = WEBrick::HTTPUtils::DefaultMimeTypes
mime_types.store 'js', 'application/javascript'
if options['default-mimetype']
  mime_types.store(nil, options['default-mimetype'])
end

s = HTTPServer.new(
  :Port            => options['server_port'],
  :MimeTypes       => mime_types
)
s.mount(options['baseurl'], HTTPServlet::FileHandler, destination)
t = Thread.new {
  s.start
}

trap("INT") { s.shutdown }
t.join()
